<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D è¡¨æƒ…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆMotionç‰ˆï¼‰</title>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar h2 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #00d4ff;
        }

        .sidebar p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
        }

        .expression-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 14px;
        }

        .expression-btn:hover {
            background: rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
            transform: translateX(5px);
        }

        .expression-btn.active {
            background: rgba(0, 212, 255, 0.5);
            border-color: #00d4ff;
        }

        .expression-btn.problem {
            background: rgba(255, 100, 100, 0.3);
            border-color: #ff6464;
        }

        .expression-btn .jp {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #canvas {
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .current-expression {
            position: absolute;
            top: 30px;
            background: rgba(0, 212, 255, 0.2);
            padding: 15px 30px;
            border-radius: 30px;
            border: 1px solid #00d4ff;
            font-size: 20px;
            text-align: center;
        }

        .current-expression small {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #00d4ff;
        }

        .instructions {
            position: absolute;
            bottom: 30px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 600px;
            text-align: center;
        }

        .problem-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .problem-list h3 {
            font-size: 14px;
            color: #ff6464;
            margin-bottom: 10px;
        }

        .problem-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 100, 100, 0.1);
            border-radius: 5px;
            font-size: 12px;
        }

        .problem-item button {
            margin-left: auto;
            padding: 3px 8px;
            font-size: 11px;
            background: rgba(255, 100, 100, 0.3);
            border: 1px solid #ff6464;
            border-radius: 3px;
            color: #fff;
            cursor: pointer;
        }

        .problem-item button:hover {
            background: rgba(255, 100, 100, 0.5);
        }

        .mark-btn {
            position: absolute;
            bottom: 100px;
            background: rgba(255, 100, 100, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #ff6464;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .mark-btn:hover {
            background: rgba(255, 100, 100, 0.5);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <h2>ğŸ­ è¡¨æƒ…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆMotionç‰ˆï¼‰</h2>
            <p>ãƒãƒ£ãƒƒãƒˆä¸­ã¨åŒã˜ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã§ç¢ºèªã§ãã¾ã™</p>
            <div id="expression-list">èª­ã¿è¾¼ã¿ä¸­...</div>

            <div class="problem-list" id="problem-list" style="display:none;">
                <h3>âš ï¸ æ°—ã«ãªã‚‹è¡¨æƒ…ãƒªã‚¹ãƒˆ</h3>
                <div id="problem-items"></div>
            </div>
        </div>
        <div class="canvas-container">
            <div class="current-expression">
                ç¾åœ¨ã®è¡¨æƒ…: <span id="current-name">neutral</span>
                <small id="file-name">motion/neutral.motion3.json</small>
            </div>
            <canvas id="canvas" width="800" height="700"></canvas>
            <div class="loading" id="loading">ğŸ”„ Live2Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <button class="mark-btn" id="mark-btn" onclick="markAsProblem()">
                ğŸš© ã“ã®è¡¨æƒ…ã‚’ã€Œæ°—ã«ãªã‚‹ã€ãƒªã‚¹ãƒˆã«è¿½åŠ 
            </button>
            <div class="instructions">
                ğŸ’¡ å·¦ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨æƒ…ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰<br>
                æ°—ã«å…¥ã‚‰ãªã„è¡¨æƒ…ã¯ã€Œæ°—ã«ãªã‚‹ã€ãƒœã‚¿ãƒ³ã§è¨˜éŒ²ã§ãã¾ã™
            </div>
        </div>
    </div>

    <script>
        // è¡¨æƒ…ãƒªã‚¹ãƒˆï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
        const expressions = [
            { name: 'neutral', jp: 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ï¼ˆç„¡è¡¨æƒ…ï¼‰' },
            { name: 'admiration', jp: 'æ„Ÿå˜†ãƒ»ç§°è³›' },
            { name: 'amusement', jp: 'æ¥½ã—ã„ãƒ»æ„‰å¿«' },
            { name: 'anger', jp: 'æ€’ã‚Š' },
            { name: 'annoyance', jp: 'ã‚¤ãƒ©ã‚¤ãƒ©ãƒ»ä¸æ©Ÿå«Œ' },
            { name: 'approval', jp: 'åŒæ„ãƒ»æ‰¿èª' },
            { name: 'caring', jp: 'æ€ã„ã‚„ã‚Š' },
            { name: 'confusion', jp: 'å›°æƒ‘' },
            { name: 'crazy', jp: 'ç‹‚æ°—' },
            { name: 'curiosity', jp: 'å¥½å¥‡å¿ƒ' },
            { name: 'desire', jp: 'æ¬²æœ›' },
            { name: 'disappointment', jp: 'è½èƒ†ãƒ»ãŒã£ã‹ã‚Š' },
            { name: 'disapproval', jp: 'ä¸è³›æˆ' },
            { name: 'disgust', jp: 'å«Œæ‚ª' },
            { name: 'embarrassment', jp: 'æ¥ãšã‹ã—ã„' },
            { name: 'excitement', jp: 'èˆˆå¥®' },
            { name: 'fear', jp: 'ææ€–' },
            { name: 'gratitude', jp: 'æ„Ÿè¬' },
            { name: 'grief', jp: 'æ‚²å˜†' },
            { name: 'jealousy', jp: 'å«‰å¦¬' },
            { name: 'joy', jp: 'å–œã³' },
            { name: 'love', jp: 'æ„›' },
            { name: 'nervousness', jp: 'ç·Šå¼µ' },
            { name: 'optimism', jp: 'æ¥½è¦³' },
            { name: 'pride', jp: 'èª‡ã‚Š' },
            { name: 'realization', jp: 'æ°—ã¥ã' },
            { name: 'relief', jp: 'å®‰å µ' },
            { name: 'remorse', jp: 'å¾Œæ‚”' },
            { name: 'sadness', jp: 'æ‚²ã—ã¿' },
            { name: 'sarprise', jp: 'é©šã' },
            { name: 'scorn', jp: 'è»½è”‘' },
            { name: 'talkinghead', jp: 'è©±ã—ä¸­' },
            { name: 'upset', jp: 'å‹•æº' },
        ];

        let currentModel = null;
        let currentExpressionName = 'neutral';
        let problemExpressions = JSON.parse(localStorage.getItem('problemExpressions') || '[]');

        // è¡¨æƒ…ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        function createExpressionButtons() {
            const container = document.getElementById('expression-list');
            container.innerHTML = '';

            expressions.forEach(expr => {
                const btn = document.createElement('button');
                btn.className = 'expression-btn';
                btn.id = `btn-${expr.name}`;
                if (problemExpressions.includes(expr.name)) {
                    btn.classList.add('problem');
                }
                btn.innerHTML = `${expr.name}<span class="jp">${expr.jp}</span>`;
                btn.onclick = () => setExpression(expr.name);
                container.appendChild(btn);
            });

            updateProblemList();
        }

        // è¡¨æƒ…ã‚’è¨­å®šï¼ˆMotionç‰ˆï¼‰
        function setExpression(name) {
            if (!currentModel) return;

            currentExpressionName = name;

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.expression-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`btn-${name}`);
            if (activeBtn) activeBtn.classList.add('active');

            // è¡¨æƒ…åã‚’æ›´æ–°
            const exprInfo = expressions.find(e => e.name === name);
            document.getElementById('current-name').textContent = exprInfo ? exprInfo.jp : name;
            document.getElementById('file-name').textContent = `motion/${name}.motion3.json`;

            // ãƒãƒ£ãƒƒãƒˆä¸­ã¨åŒã˜å‡¦ç†ï¼šExpression + Motion ã‚’ä¸¡æ–¹å®Ÿè¡Œ
            try {
                // 1. Expression ã‚’è¨­å®š
                currentModel.expression(name);
                console.log('Expression set:', name);

                // 2. Motion ã‚’å†ç”Ÿï¼ˆãƒãƒ£ãƒƒãƒˆä¸­ã¨åŒã˜ï¼‰
                const motionManager = currentModel.internalModel.motionManager;
                const definitions = motionManager.definitions;

                if (definitions && definitions['']) {
                    const motionIndex = definitions[''].findIndex(m =>
                        m.File && m.File.toLowerCase().includes(name.toLowerCase() + '.motion3.json')
                    );

                    if (motionIndex >= 0) {
                        motionManager.startMotion('', motionIndex);
                        console.log('Motion started:', name, 'index:', motionIndex);
                    } else {
                        console.warn('Motion not found for:', name);
                    }
                }
            } catch (e) {
                console.error('Failed to set expression/motion:', e);
            }
        }

        // æ°—ã«ãªã‚‹è¡¨æƒ…ã¨ã—ã¦ãƒãƒ¼ã‚¯
        function markAsProblem() {
            if (!currentExpressionName) return;

            if (!problemExpressions.includes(currentExpressionName)) {
                problemExpressions.push(currentExpressionName);
                localStorage.setItem('problemExpressions', JSON.stringify(problemExpressions));

                const btn = document.getElementById(`btn-${currentExpressionName}`);
                if (btn) btn.classList.add('problem');

                updateProblemList();
            }
        }

        // å•é¡Œãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateProblemList() {
            const container = document.getElementById('problem-items');
            const listDiv = document.getElementById('problem-list');

            if (problemExpressions.length === 0) {
                listDiv.style.display = 'none';
                return;
            }

            listDiv.style.display = 'block';
            container.innerHTML = '';

            problemExpressions.forEach(name => {
                const exprInfo = expressions.find(e => e.name === name);
                const item = document.createElement('div');
                item.className = 'problem-item';
                item.innerHTML = `
                    <span>${name} (${exprInfo ? exprInfo.jp : ''})</span>
                    <button onclick="removeProblem('${name}')">å‰Šé™¤</button>
                `;
                container.appendChild(item);
            });
        }

        // å•é¡Œãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        function removeProblem(name) {
            problemExpressions = problemExpressions.filter(n => n !== name);
            localStorage.setItem('problemExpressions', JSON.stringify(problemExpressions));

            const btn = document.getElementById(`btn-${name}`);
            if (btn) btn.classList.remove('problem');

            updateProblemList();
        }

        // Live2Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿
        async function loadModel() {
            const app = new PIXI.Application({
                view: document.getElementById('canvas'),
                width: 800,
                height: 700,
                backgroundAlpha: 0,
            });

            try {
                currentModel = await PIXI.live2d.Live2DModel.from(
                    './é•·è°·éƒ¨ç¬¬å››å¼¾4001ãƒ•ãƒªãƒ¼/é•·è°·éƒ¨ç¬¬å››å¼¾4001ãƒ•ãƒªãƒ¼.model3.json'
                );

                // ãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚ºã¨ä½ç½®ã‚’èª¿æ•´
                currentModel.scale.set(0.35);
                currentModel.anchor.set(0.5, 0.5);
                currentModel.x = app.screen.width / 2;
                currentModel.y = app.screen.height / 2 + 50;

                app.stage.addChild(currentModel);

                document.getElementById('loading').style.display = 'none';
                console.log('Model loaded successfully!');

                // åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
                const motionDefs = currentModel.internalModel.motionManager.definitions;
                console.log('Available motions:', motionDefs);

            } catch (error) {
                document.getElementById('loading').textContent = 'âŒ ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                console.error('Failed to load model:', error);
            }
        }

        // åˆæœŸåŒ–
        createExpressionButtons();
        loadModel();
    </script>
</body>

</html>